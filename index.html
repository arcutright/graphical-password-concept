<!DOCTYPE html PUBLIC"-//W3C//DTD XHTML 1.0 Strict//EN" 
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
	<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<style>
	#canvas, #canvas img{
		width: 500px;
		height: 300px;
	}
	#canvas{
		position:relative;
	}
	#canvas img{
		position: absolute;
		left: 0;
		top: 0;
	}
	.selection-area{
	  position: absolute;
	  outline-color: red;
	}
	</style>
	</head>
	<body>
		<form id='login' method='post' accept-charset='UTF-8'>
			Username:<br>
  			<input type="text" name="username"><br>
  			<input type="submit" value="Password">
		</form>
		<div id='canvas' style='display:none'>
			<img src='/imagenotfound.jpg'>
		</div>
		<p id='mouselocation'></p>
		<p id='selectregion'></p>
	</body>
	<!-- external script dependencies -->
	<script src="https://code.jquery.com/jquery-2.2.3.min.js" integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo=" crossorigin="anonymous"></script>

	<script type='text/javascript'>
	// selector caching
	var canvas = $('#canvas');
	var mouselocation = $('#mouselocation');
	var selectregion = $('#selectregion');

	$(document).ready( function(){
		// get chunk directory, get starting image
		var username;

		$('#login').on('submit', function(e){
			e.preventDefault();
			$('#canvas').hide();
			username = $('input[name="username"]', this)[0].value;
			console.log('username: "'+username+'"');

			var postData = [username, mouseEntropy];
			postData = JSON.stringify(postData);

			var request = $.ajax({
				url: '/changeImage.php',
				type: 'post',
				data: 'login='+postData,
				success: function(responseData, textStatus, jqXHR){
					console.log('raw response:');
					console.log(responseData);
					responseData = JSON.parse(responseData);
					// response validation
					if(typeof responseData === 'string' && responseData.length > 0){
						var initialImageURL = responseData;
						if(imageExists(initialImageURL)){
							var img = $('#canvas img')[0]
							img.src = initialImageURL;
							img.onload = function(){ $('#canvas').show(); };
							mouseEntropy = '';
						}
					}
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log('initial login fail');
					console.log(textStatus, errorThrown);
				}
			});
		});

		// capture mouse movement
		var mouseEntropy = '';
		$(document).mousemove( function(e){
			var x = e.pageX;
			var y = e.pageY;
			mouseEntropy += x + y;
			mouselocation.html('mouse location   x: '+x + '   y: '+y);
		});

		// define grid for mouse clicks
		var clickmap = document.createElement('div');
		clickmap.id = 'clickmap';
		var errorMargin = 50;

		for(var y=0; y < canvas.height(); y += errorMargin){
			for(var x=0; x < canvas.width(); x += errorMargin){
				// area: each cell in the grid
				var area = document.createElement('div');
				area.className = 'selection-area';
				area.style.left = x + 'px';
				area.style.top = y + 'px';
				area.style.width = errorMargin + 'px';
				area.style.height = errorMargin + 'px';
				area.onmouseover = function(){
					this.style.outlineStyle = 'solid';
				};
				area.onmouseout = function(){
					this.style.outlineStyle = 'none';
				};
				area.onclick = function(){
					selectregion.html('region   x:'+parseFloat(this.style.left)/errorMargin+
						'  y: '+parseFloat(this.style.top)/errorMargin);
					changeImage($('#canvas img')[0], parseFloat(this.style.left)/errorMargin,
						parseFloat(this.style.top)/errorMargin);
				};
				clickmap.appendChild(area);
			}
		}
		canvas[0].appendChild(clickmap);
	});

	// chain to provide server with info about prev images, hopefully encrypted
	var dataChain = '';
	// chunk to retrieve images from
	var chunk;

	// change image based on user response
	function changeImage(img, gridX, gridY){
		var postData = [dataChain, img.src, [gridX, gridY]];
		postData = JSON.stringify(postData);
		// post to server
		$.ajax({
			type: 'POST',
			url: "/changeImage.php",
			data: 'changeImage=' + postData,
			dataType: "html",
			cache: false,
			contentTyoe: false,
			processData: false,
			success: function(responseData, textStatus, jqXHR) {
				responseData = JSON.parse(responseData);
				// response validation
				if(responseData.constructor === Array && responseData.length == 2){
					var responseChain = responseData[0];
					var responseImageURL = responseData[1];
					console.log('responseChain: ['+ responseChain +']');
					console.log('responseURL: ['+ responseImageURL +']');
					if(imageExists(responseImageURL)){
						//response is valid
						img.src = responseImageURL;
						dataChain = responseChain;
					}
				}
			},
			error: function(jqXHR, textStatus, errorThrown) {
				console.log('changeimage fail');
				console.log(textStatus, errorThrown);
			}
		});
	}

	function checkLogin(username, dataChain){
		var postData = [username, dataChain];
		postData = JSON.stringify(postData);
		// post to server
		$.ajax({
			type: 'POST',
			url: "/changeImage.php",
			data: 'checkLogin=' + postData,
			dataType: "html",
			cache: false,
			contentTyoe: false,
			processData: false,
			done: function(responseData, textStatus, jqXHR) {
				responseData = JSON.parse(responseData);
				// response validation
				console.log('login response:');
				console.log(responseData);
				return true;
			},
			fail: function(jqXHR, textStatus, errorThrown) {
				console.log('authenticated login fail');
				console.log(textStatus, errorThrown);
			}
		});
		return false;
	}

	// verify image existance
	function imageExists(url) {
		if(typeof url === 'string' && url.length > 0){
			var http = new XMLHttpRequest();
		    http.open('HEAD', url, false);
		    http.send();
		    return http.status != 404;
		}
		return false;
	}
	</script>
</html>